
<% layout("/layouts/boilerplate.ejs") %>
<style>
    table {
        width: 85%;
        text-align: center;
        margin: 20px auto;
    }
    th, td {
        border: 1px solid black; 
        text-align: center; 
        vertical-align: middle;
        padding: 10px; 
        min-width: 120px;
        height: 50px;
        word-wrap: break-word;
    }
    th {
        background-color: #f2f2f2;
        font-weight: bold;
    }
    .timetable-container {
        margin-bottom: 30px;
    }
    .center-button {
        text-align: center;
        margin-top: 20px;
    }
</style>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <%- include("includes/student_sidebar.ejs") %>

        <!-- Main Content -->
        <div class="content">
            
            <h2 class="text-center mb-4" style="color: black;"><i class="bi bi-calendar"></i> Student Timetable</h2>
            
            <% classTimetables.forEach(timetable => { %>
                <div id="timetable_<%= timetable.class_id %>" class="timetable-container border rounded p-3 mb-4 shadow-sm bg-light">
                    <h3 style="text-align: center;"><%= timetable.class_name %> Timetable</h3>
                    <table id="timetableTable_<%= timetable.class_id %>">
                        <thead>
                            <tr>
                                <th>Time / Day</th>
                                <th>Monday</th>
                                <th>Tuesday</th>
                                <th>Wednesday</th>
                                <th>Thursday</th>
                                <th>Friday</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% count=0 %>
                            <% for (let pd = 1; pd <= periodTimings.length; pd++) { %>
                                <% period = pd-count %>
                                <tr>
                                    <% if (periodTimings[pd-1].includes("Break")) { %>
                                        <% count++ %>
                                        
                                        <th colspan="6" style="text-align: center; background-color: lightgray;"><%= periodTimings[pd-1] %></th>
                                    <% } else { %>
                                        <th><%= periodTimings[pd-1] %></th>
                                        <% ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].forEach(day => { %>
                                            <td>
                                                <% if (timetable.timetable[period] && timetable.timetable[period][day]) { %>
                                                    <%= timetable.timetable[period][day].subject_name %><br>
                                                    <%= timetable.timetable[period][day].teacher_name %><br>
                                                    <%= timetable.timetable[period][day].room_name %>
                                                <% } else { %>
                                                    -
                                                <% } %>
                                            </td>
                                        <% }); %>
                                    <% } %>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                    <br>
                    <div class="text-center">
                        <button class="btn btn-success" onclick="downloadPDF('<%= timetable.class_id %>')">
                            <i class="bi bi-file-earmark-pdf"></i> Download PDF
                        </button>
                    </div>
                
                </div>
            <% }); %>
        

        </div>
    </div>
    <script>
        
        function downloadPDF(classId) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: "landscape",
                unit: "mm",
                format: "a4"
            });

            // Get class name for title
            const className = document.querySelector(`#timetable_${classId} h3`).innerText.replace(" Timetable", "");

            // Add title
            doc.setFontSize(18);
            doc.text(`Timetable for ${className}`, 140, 15, { align: "center" });

            // Define table headers
            const headers = ["Time / Day", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

            // Extract table data from the existing timetable table
            const table = document.querySelector(`#timetableTable_${classId}`);
            const rows = table.querySelectorAll("tbody tr");
            
            const tableData = [];

            rows.forEach(row => {
                const cols = row.querySelectorAll("th, td");
                const rowData = [];

                cols.forEach(col => {
                    if (col.colSpan > 1) {
                        // Handle Breaks
                        rowData.push({ content: col.innerText, colSpan: col.colSpan, styles: { halign: "center", fillColor: [200, 200, 200] } });
                    } else {
                        rowData.push(col.innerText.trim());
                    }
                });

                tableData.push(rowData);
            });

            // Generate PDF table
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 25,
                theme: 'grid',
                styles: {
                    fontSize: 10,
                    cellPadding: 4,
                    valign: "middle"
                },
                headStyles: { fillColor: [100, 150, 255] },
                alternateRowStyles: { fillColor: [240, 240, 240] },
            });

            // Save the file
            doc.save(`Timetable_${className}.pdf`);
        }
    </script>
</body> 